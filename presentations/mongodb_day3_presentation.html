<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Day 3: Advanced Features & Production</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/theme/night.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/plugin/highlight/monokai.min.css">
    <style>
        .reveal {
            font-family: "Source Sans Pro", Helvetica, sans-serif;
            font-size: 32px;
        }
        .reveal h1, .reveal h2, .reveal h3 {
            color: #13DAEC;
        }
        .reveal h1 { font-size: 2.2em; }
        .reveal h2 { font-size: 1.8em; }
        .reveal h3 { font-size: 1.4em; }
        .reveal .slides section .fragment.highlight-green {
            opacity: 1;
            visibility: inherit;
        }
        .reveal .slides section .fragment.highlight-green.visible {
            background-color: #17ff2e;
            color: #000;
        }
        .reveal .slides section .fragment.highlight-red {
            opacity: 1;
            visibility: inherit;
        }
        .reveal .slides section .fragment.highlight-red.visible {
            background-color: #ff2c2d;
            color: #fff;
        }
        .code-container {
            position: relative;
        }
        .code-title {
            background: #13DAEC;
            color: #000;
            padding: 5px 10px;
            font-size: 0.7em;
            font-weight: bold;
            margin-bottom: 0;
        }
        .two-column {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }
        .column {
            flex: 1;
        }
        .small-text {
            font-size: 0.75em;
        }
        .smaller-text {
            font-size: 0.65em;
        }
        .large-text {
            font-size: 1.2em;
        }
        .highlight {
            background-color: #13DAEC;
            color: #000;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .architecture-diagram {
            border: 2px solid #13DAEC;
            padding: 15px;
            margin: 10px;
            border-radius: 10px;
            background: rgba(19, 218, 236, 0.1);
            font-size: 0.8em;
        }
        .pros-cons {
            display: flex;
            gap: 15px;
        }
        .pros, .cons {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.75em;
        }
        .pros {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #00ff00;
        }
        .cons {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff0000;
        }
        pre {
            font-size: 0.55em !important;
        }
        code {
            max-height: 450px;
        }
        .reveal ul, .reveal ol {
            margin: 0.5em 0;
        }
        .reveal li {
            margin: 0.3em 0;
        }
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">
            <!-- Title Slide -->
            <section>
                <h1>MongoDB Mastering Course</h1>
                <h2>Day 3: Advanced Features & Production</h2>
                <p>
                    <strong>Topics:</strong> Transactions ‚Ä¢ Replication ‚Ä¢ Sharding ‚Ä¢ Change Streams ‚Ä¢ Production Deployment
                </p>
                <p class="small-text">
                    Docker-based Environment
                </p>
            </section>

            <!-- Course Overview -->
            <section>
                <h2>Day 3 Learning Objectives</h2>
                <ul>
                    <li class="fragment">üîÑ Master ACID transactions in MongoDB</li>
                    <li class="fragment">üîß Implement replica sets for high availability</li>
                    <li class="fragment">‚ö° Design sharding strategies for horizontal scaling</li>
                    <li class="fragment">üì° Build real-time applications with change streams</li>
                    <li class="fragment">üöÄ Deploy production-ready MongoDB clusters</li>
                    <li class="fragment">üõ°Ô∏è Implement monitoring and security best practices</li>
                </ul>
            </section>

            <!-- Session Agenda -->
            <section>
                <h2>Session Agenda</h2>
                <div class="two-column">
                    <div class="column">
                        <h3>Morning Session</h3>
                        <ul class="small-text">
                            <li><strong>Transactions & ACID</strong></li>
                            <li><strong>Replica Sets & HA</strong></li>
                        </ul>
                    </div>
                    <div class="column">
                        <h3>Afternoon Session</h3>
                        <ul class="small-text">
                            <li><strong>Sharding & Scaling</strong></li>
                            <li><strong>Change Streams</strong></li>
                            <li><strong>Production Deployment</strong></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Part 1: Transactions -->
            <section>
                <section>
                    <h1>Part 1: Transactions & ACID</h1>
                    <p class="large-text">Ensuring Data Consistency in MongoDB</p>
                </section>

                <section>
                    <h2>What are MongoDB Transactions?</h2>
                    <div class="fragment">
                        <p><strong>Definition:</strong> Multi-document operations that execute atomically</p>
                        <div class="architecture-diagram">
                            <h3>ACID Properties</h3>
                            <ul class="small-text">
                                <li><span class="highlight">Atomicity:</span> All-or-nothing execution</li>
                                <li><span class="highlight">Consistency:</span> Data remains valid</li>
                                <li><span class="highlight">Isolation:</span> Concurrent operations don't interfere</li>
                                <li><span class="highlight">Durability:</span> Changes persist after commit</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>When to Use Transactions</h2>
                    <div class="pros-cons">
                        <div class="pros">
                            <h3>‚úÖ Use When:</h3>
                            <ul>
                                <li>Multi-document updates needed</li>
                                <li>Financial operations</li>
                                <li>Complex business logic</li>
                                <li>Data integrity critical</li>
                                <li>Rollback capability required</li>
                            </ul>
                        </div>
                        <div class="cons">
                            <h3>‚ùå Avoid When:</h3>
                            <ul>
                                <li>Single document operations</li>
                                <li>High-throughput scenarios</li>
                                <li>Simple read operations</li>
                                <li>Performance is critical</li>
                                <li>Eventually consistent is OK</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Basic Transaction Pattern</h2>
                    <div class="code-container">
                        <div class="code-title">JavaScript Transaction Syntax</div>
                        <pre><code class="javascript">// Start a session
const session = client.startSession();

try {
  // Start transaction
  session.startTransaction();
  
  // Perform operations within transaction
  await db.accounts.updateOne(
    { _id: "account1" },
    { $inc: { balance: -100 } },
    { session }
  );
  
  await db.accounts.updateOne(
    { _id: "account2" },
    { $inc: { balance: 100 } },
    { session }
  );
  
  // Commit transaction
  await session.commitTransaction();
  
} catch (error) {
  // Rollback on error
  await session.abortTransaction();
  throw error;
} finally {
  await session.endSession();
}</code></pre>
                    </div>
                </section>

                <section>
                    <h2>E-commerce Order Example</h2>
                    <div class="code-container">
                        <div class="code-title">Order Processing Transaction</div>
                        <pre><code class="javascript">async function processOrder(orderId, items) {
  const session = client.startSession();
  
  try {
    session.startTransaction({
      readConcern: { level: "snapshot" },
      writeConcern: { w: "majority" }
    });
    
    // 1. Check inventory
    for (const item of items) {
      const product = await db.products.findOne(
        { _id: item.productId, stock: { $gte: item.quantity } },
        { session }
      );
      if (!product) throw new Error(`Insufficient stock`);
    }
    
    // 2. Update inventory
    for (const item of items) {
      await db.products.updateOne(
        { _id: item.productId },
        { $inc: { stock: -item.quantity } },
        { session }
      );
    }
    
    // 3. Create order
    await db.orders.insertOne({
      _id: orderId, items: items, status: "confirmed"
    }, { session });
    
    await session.commitTransaction();
    return { success: true, orderId };
    
  } catch (error) {
    await session.abortTransaction();
    return { success: false, error: error.message };
  } finally {
    await session.endSession();
  }
}</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Transaction Performance</h2>
                    <div class="fragment">
                        <h3>Performance Impact</h3>
                        <ul class="small-text">
                            <li><strong>Latency:</strong> +10-30ms overhead per transaction</li>
                            <li><strong>Throughput:</strong> ~10-50% reduction depending on workload</li>
                            <li><strong>Lock contention:</strong> Can affect concurrent operations</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <h3>Optimization Tips</h3>
                        <ul class="small-text">
                            <li>Keep transactions short-lived (&lt;60 seconds)</li>
                            <li>Use appropriate read/write concerns</li>
                            <li>Minimize cross-shard transactions</li>
                            <li>Use retryable writes for resilience</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Docker Setup for Transactions</h2>
                    <div class="code-container">
                        <div class="code-title">Replica Set Required</div>
                        <pre><code class="yaml"># docker-compose.yml for transactions
version: '3.8'
services:
  mongo1:
    image: mongo:7.0
    container_name: mongo1
    command: mongod --replSet myReplicaSet --bind_ip_all
    ports: ["27017:27017"]
    
  mongo2:
    image: mongo:7.0
    container_name: mongo2
    command: mongod --replSet myReplicaSet --bind_ip_all
    ports: ["27018:27017"]
    
  mongo3:
    image: mongo:7.0
    container_name: mongo3
    command: mongod --replSet myReplicaSet --bind_ip_all
    ports: ["27019:27017"]</code></pre>
                    </div>
                    <div class="fragment small-text">
                        <p><strong>Note:</strong> Transactions require replica sets or sharded clusters</p>
                    </div>
                </section>
            </section>

            <!-- Part 2: Replica Sets -->
            <section>
                <section>
                    <h1>Part 2: Replica Sets & High Availability</h1>
                    <p class="large-text">Building Resilient MongoDB Deployments</p>
                </section>

                <section>
                    <h2>Replica Set Architecture</h2>
                    <div class="architecture-diagram">
                        <div style="text-align: center;">
                            <div style="display: flex; justify-content: space-around; align-items: center;">
                                <div style="border: 2px solid #00ff00; padding: 10px; border-radius: 5px;">
                                    <strong>PRIMARY</strong><br>
                                    Read/Write
                                </div>
                                <div style="border: 2px solid #ffff00; padding: 10px; border-radius: 5px;">
                                    <strong>SECONDARY</strong><br>
                                    Read Only*
                                </div>
                                <div style="border: 2px solid #ffff00; padding: 10px; border-radius: 5px;">
                                    <strong>SECONDARY</strong><br>
                                    Read Only*
                                </div>
                            </div>
                            <p class="smaller-text">*When read preference is configured</p>
                        </div>
                    </div>
                    <ul class="fragment small-text">
                        <li>Automatic failover when primary becomes unavailable</li>
                        <li>Data redundancy across multiple servers</li>
                        <li>Zero downtime for planned maintenance</li>
                    </ul>
                </section>

                <section>
                    <h2>Replica Set Members</h2>
                    <div class="two-column small-text">
                        <div class="column">
                            <h3>Primary Node</h3>
                            <ul>
                                <li>Receives all write operations</li>
                                <li>Records changes in oplog</li>
                                <li>Only one per replica set</li>
                                <li>Elected by majority vote</li>
                            </ul>
                            <h3>Secondary Nodes</h3>
                            <ul>
                                <li>Replicate primary's oplog</li>
                                <li>Can serve read operations</li>
                                <li>Participate in elections</li>
                                <li>Can become primary</li>
                            </ul>
                        </div>
                        <div class="column">
                            <h3>Special Members</h3>
                            <ul>
                                <li><strong>Arbiter:</strong> Voting only, no data</li>
                                <li><strong>Hidden:</strong> Data replication, no client reads</li>
                                <li><strong>Delayed:</strong> Historical data snapshots</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Setting Up Replica Set</h2>
                    <div class="code-container">
                        <div class="code-title">Replica Set Initialization</div>
                        <pre><code class="javascript">// Connect to primary node
mongosh --host localhost:27017

// Initialize replica set
rs.initiate({
  _id: "myReplicaSet",
  members: [
    { _id: 0, host: "mongo1:27017", priority: 2 },
    { _id: 1, host: "mongo2:27017", priority: 1 },
    { _id: 2, host: "mongo3:27017", priority: 1 }
  ]
})

// Check replica set status
rs.status()

// Add additional members
rs.add("mongo4:27017")

// Remove members
rs.remove("mongo4:27017")</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Advanced Configuration</h2>
                    <div class="code-container">
                        <div class="code-title">Replica Set with Special Members</div>
                        <pre><code class="javascript">rs.initiate({
  _id: "myReplicaSet",
  members: [
    { 
      _id: 0, host: "mongo1:27017", 
      priority: 2, votes: 1    // Preferred primary
    },
    { 
      _id: 1, host: "mongo2:27017", 
      priority: 1, votes: 1    // Regular secondary
    },
    { 
      _id: 2, host: "mongo3:27017", 
      priority: 0, hidden: true, // Hidden member
      slaveDelay: 3600          // 1 hour delay
    },
    {
      _id: 3, host: "arbiter:27017",
      arbiterOnly: true         // Arbiter only
    }
  ],
  settings: {
    electionTimeoutMillis: 10000,
    heartbeatIntervalMillis: 2000
  }
})</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Read Preferences</h2>
                    <div class="fragment">
                        <h3>Read Preference Modes</h3>
                        <ul class="small-text">
                            <li><span class="highlight">primary</span> - Default, read from primary only</li>
                            <li><span class="highlight">primaryPreferred</span> - Primary if available, secondary otherwise</li>
                            <li><span class="highlight">secondary</span> - Read from secondary only</li>
                            <li><span class="highlight">secondaryPreferred</span> - Secondary if available, primary otherwise</li>
                            <li><span class="highlight">nearest</span> - Lowest network latency</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <div class="code-container">
                            <div class="code-title">Using Read Preferences</div>
                            <pre><code class="javascript">// Read from secondary
db.products.find().readPref("secondary")

// Read with tag preferences
db.products.find().readPref("secondary", [
  { "datacenter": "west" },
  { "datacenter": "east" }
])

// Connection string with read preference
mongodb://host1,host2,host3/mydb?readPreference=secondaryPreferred</code></pre>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Write & Read Concerns</h2>
                    <div class="two-column">
                        <div class="column">
                            <h3>Write Concerns</h3>
                            <div class="code-container">
                                <pre><code class="javascript">// Majority write concern
db.users.insertOne(
  { name: "John" },
  { writeConcern: { w: "majority" } }
)

// Custom write concern
db.users.updateOne(
  { _id: id },
  { $set: { status: "active" } },
  { 
    writeConcern: { 
      w: 2,           // 2 nodes
      j: true,        // Journal
      wtimeout: 5000  // Timeout
    } 
  }
)</code></pre>
                            </div>
                        </div>
                        <div class="column">
                            <h3>Read Concerns</h3>
                            <div class="code-container">
                                <pre><code class="javascript">// Majority read concern
db.orders.find({ status: "pending" })
  .readConcern("majority")

// Snapshot read concern
session.startTransaction({
  readConcern: { level: "snapshot" },
  writeConcern: { w: "majority" }
})

// Linearizable read concern
db.inventory.findOne({ _id: productId })
  .readConcern("linearizable")</code></pre>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Monitoring Replica Sets</h2>
                    <div class="code-container">
                        <div class="code-title">Essential Monitoring Commands</div>
                        <pre><code class="javascript">// Replica set status
rs.status()

// Check replication lag
db.runCommand({ replSetGetStatus: 1 }).members.forEach(member => {
  if (member.state === 2) { // Secondary
    console.log(`${member.name}: ${member.optimeDate}`)
  }
})

// Oplog information
db.oplog.rs.find().sort({ ts: -1 }).limit(5)

// Step down primary (for maintenance)
rs.stepDown(60) // Step down for 60 seconds

// Force reconfiguration
rs.reconfig(config, { force: true })</code></pre>
                    </div>
                </section>
            </section>

            <!-- Part 3: Sharding -->
            <section>
                <section>
                    <h1>Part 3: Sharding & Horizontal Scaling</h1>
                    <p class="large-text">Scaling MongoDB Beyond Single Machines</p>
                </section>

                <section>
                    <h2>Sharded Cluster Architecture</h2>
                    <div class="architecture-diagram">
                        <div style="text-align: center; font-size: 0.8em;">
                            <div style="margin-bottom: 15px;">
                                <div style="border: 2px solid #ff9900; padding: 8px; display: inline-block; border-radius: 5px;">
                                    <strong>mongos</strong> (Query Router)
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-around; margin-bottom: 15px;">
                                <div style="border: 2px solid #00ff00; padding: 8px; border-radius: 5px;">
                                    <strong>Shard 1</strong><br>
                                    Replica Set
                                </div>
                                <div style="border: 2px solid #00ff00; padding: 8px; border-radius: 5px;">
                                    <strong>Shard 2</strong><br>
                                    Replica Set
                                </div>
                                <div style="border: 2px solid #00ff00; padding: 8px; border-radius: 5px;">
                                    <strong>Shard 3</strong><br>
                                    Replica Set
                                </div>
                            </div>
                            <div>
                                <div style="border: 2px solid #9900ff; padding: 8px; display: inline-block; border-radius: 5px;">
                                    <strong>Config Servers</strong> (Metadata)
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>When to Shard?</h2>
                    <div class="fragment">
                        <h3>Consider Sharding When:</h3>
                        <ul class="small-text">
                            <li>üóÑÔ∏è Data size exceeds single server capacity (&gt;2TB working set)</li>
                            <li>üöÄ Read/write throughput exceeds single server capability</li>
                            <li>üíæ RAM requirements exceed what's economically feasible</li>
                            <li>üåç Geographic distribution needed</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <h3>Alternatives to Consider First:</h3>
                        <ul class="smaller-text">
                            <li>Vertical scaling (more RAM, faster disks)</li>
                            <li>Read replicas for read scaling</li>
                            <li>Data archiving/purging</li>
                            <li>Application-level partitioning</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Shard Key Selection</h2>
                    <div class="fragment">
                        <p><strong>Critical Decision:</strong> Cannot be changed after sharding!</p>
                        <h3>Good Shard Key Characteristics:</h3>
                        <ul class="small-text">
                            <li><span class="highlight">High Cardinality:</span> Many possible values</li>
                            <li><span class="highlight">Good Distribution:</span> Values spread evenly</li>
                            <li><span class="highlight">Query Isolation:</span> Queries hit few shards</li>
                            <li><span class="highlight">Write Scaling:</span> No hot spots</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Shard Key Examples</h2>
                    <div class="two-column small-text">
                        <div class="column">
                            <h3>‚ùå Poor Shard Keys</h3>
                            <div class="code-container">
                                <pre><code class="javascript">// Monotonically increasing
{ _id: ObjectId() }
{ timestamp: Date }
{ incrementalId: Number }

// Low cardinality
{ status: "active|inactive" }
{ category: "A|B|C" }

// Hotspots
{ userId: currentUser }
{ region: mostActiveRegion }</code></pre>
                            </div>
                        </div>
                        <div class="column">
                            <h3>‚úÖ Good Shard Keys</h3>
                            <div class="code-container">
                                <pre><code class="javascript">// Hashed keys
{ _id: "hashed" }

// Compound keys
{ userId: 1, timestamp: 1 }
{ customerId: 1, orderId: 1 }

// Geographic
{ location: 1, timestamp: 1 }

// Application-specific
{ tenantId: 1, documentId: 1 }</code></pre>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Sharded Cluster Setup</h2>
                    <div class="code-container">
                        <div class="code-title">Setting Up Sharding</div>
                        <pre><code class="javascript">// 1. Start config servers (replica set)
mongod --configsvr --replSet configRS --port 27019 --dbpath /data/config

// 2. Start shard servers (replica sets)
mongod --shardsvr --replSet shard1RS --port 27018 --dbpath /data/shard1

// 3. Start mongos (query router)
mongos --configdb configRS/config1:27019,config2:27019 --port 27017

// 4. Connect to mongos and add shards
mongosh --host localhost:27017
sh.addShard("shard1RS/shard1-1:27018,shard1-2:27018")
sh.addShard("shard2RS/shard2-1:27018,shard2-2:27018")

// 5. Enable sharding on database
sh.enableSharding("ecommerce")

// 6. Shard collections
sh.shardCollection("ecommerce.orders", { customerId: 1, orderDate: 1 })
sh.shardCollection("ecommerce.products", { _id: "hashed" })</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Docker Sharding Setup</h2>
                    <div class="code-container">
                        <div class="code-title">Docker Compose for Sharding</div>
                        <pre><code class="yaml">version: '3.8'
services:
  # Config Servers
  config1:
    image: mongo:7.0
    command: mongod --configsvr --replSet configRS --port 27017 --bind_ip_all
    
  # Shard 1
  shard1-1:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard1RS --port 27017 --bind_ip_all
    
  shard1-2:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard1RS --port 27017 --bind_ip_all
    
  # Shard 2
  shard2-1:
    image: mongo:7.0
    command: mongod --shardsvr --replSet shard2RS --port 27017 --bind_ip_all
    
  # Query Router
  mongos:
    image: mongo:7.0
    command: mongos --configdb configRS/config1:27017 --bind_ip_all --port 27017
    ports: ["27017:27017"]
    depends_on: [config1, shard1-1, shard2-1]</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Managing Sharded Clusters</h2>
                    <div class="code-container">
                        <div class="code-title">Sharding Administration</div>
                        <pre><code class="javascript">// Check sharding status
sh.status()

// View chunk distribution
db.chunks.find({ ns: "ecommerce.orders" })

// Manual chunk operations
sh.splitAt("ecommerce.orders", { customerId: "customer1000" })
sh.moveChunk("ecommerce.orders", 
  { customerId: "customer1000" }, 
  "shard2RS")

// Balancer management
sh.startBalancer()
sh.stopBalancer()
sh.getBalancerState()

// Zone sharding (geographic)
sh.addShardTag("shard1RS", "US-EAST")
sh.addShardTag("shard2RS", "US-WEST")
sh.addTagRange("ecommerce.users", 
  { region: "east" }, { region: "east\uffff" }, "US-EAST")</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Sharding Best Practices</h2>
                    <div class="two-column small-text">
                        <div class="column">
                            <h3>Performance</h3>
                            <ul>
                                <li>Choose shard key carefully</li>
                                <li>Pre-split chunks for even distribution</li>
                                <li>Monitor balancer activity</li>
                                <li>Use targeted queries when possible</li>
                            </ul>
                        </div>
                        <div class="column">
                            <h3>Operations</h3>
                            <ul>
                                <li>Always use odd number of config servers</li>
                                <li>Monitor chunk distribution</li>
                                <li>Plan for shard maintenance</li>
                                <li>Consider zone sharding for compliance</li>
                            </ul>
                        </div>
                    </div>
                    <div class="fragment">
                        <h3>‚ö†Ô∏è Common Pitfalls</h3>
                        <ul class="smaller-text">
                            <li>Choosing wrong shard key (irreversible!)</li>
                            <li>Creating hotspots with monotonic keys</li>
                            <li>Not considering query patterns</li>
                            <li>Underestimating operational complexity</li>
                        </ul>
                    </div>
                </section>
            </section>

            <!-- Part 4: Change Streams -->
            <section>
                <section>
                    <h1>Part 4: Change Streams</h1>
                    <p class="large-text">Real-time Applications with MongoDB</p>
                </section>

                <section>
                    <h2>What are Change Streams?</h2>
                    <div class="fragment">
                        <p><strong>Definition:</strong> Real-time streams of data changes in MongoDB</p>
                        <div class="architecture-diagram">
                            <h3>Change Stream Flow</h3>
                            <div style="text-align: center; font-size: 0.8em;">
                                <div style="display: flex; align-items: center; justify-content: space-around;">
                                    <div style="border: 2px solid #00ff00; padding: 8px; border-radius: 5px;">
                                        Database<br>Operations
                                    </div>
                                    <div>‚Üí</div>
                                    <div style="border: 2px solid #ffff00; padding: 8px; border-radius: 5px;">
                                        Oplog<br>Entries
                                    </div>
                                    <div>‚Üí</div>
                                    <div style="border: 2px solid #ff9900; padding: 8px; border-radius: 5px;">
                                        Change<br>Stream
                                    </div>
                                    <div>‚Üí</div>
                                    <div style="border: 2px solid #9900ff; padding: 8px; border-radius: 5px;">
                                        Application<br>Handlers
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <ul class="fragment small-text">
                        <li>Built on MongoDB's oplog</li>
                        <li>Resumable and fault-tolerant</li>
                        <li>Available for replica sets and sharded clusters</li>
                    </ul>
                </section>

                <section>
                    <h2>Change Stream Use Cases</h2>
                    <div class="two-column small-text">
                        <div class="column">
                            <h3>Real-time Applications</h3>
                            <ul>
                                <li>Live dashboards</li>
                                <li>Chat applications</li>
                                <li>Collaborative editing</li>
                                <li>Activity feeds</li>
                                <li>Live notifications</li>
                            </ul>
                        </div>
                        <div class="column">
                            <h3>Data Integration</h3>
                            <ul>
                                <li>ETL pipelines</li>
                                <li>Cache invalidation</li>
                                <li>Search index updates</li>
                                <li>Data synchronization</li>
                                <li>Audit logging</li>
                            </ul>
                        </div>
                    </div>
                    <div class="fragment">
                        <h3>Business Logic</h3>
                        <ul class="smaller-text">
                            <li>Order processing workflows</li>
                            <li>Inventory management</li>
                            <li>User behavior analytics</li>
                            <li>Fraud detection</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Basic Change Stream Usage</h2>
                    <div class="code-container">
                        <div class="code-title">Watching Collection Changes</div>
                        <pre><code class="javascript">// Watch all changes on a collection
const changeStream = db.orders.watch();

changeStream.on('change', (change) => {
  console.log('Change detected:', change);
  
  switch(change.operationType) {
    case 'insert':
      handleNewOrder(change.fullDocument);
      break;
    case 'update':
      handleOrderUpdate(change.documentKey._id, change.updateDescription);
      break;
    case 'delete':
      handleOrderDeletion(change.documentKey._id);
      break;
  }
});

// Watch specific operations
const insertStream = db.orders.watch([
  { $match: { operationType: 'insert' } }
]);

// Watch with filters
const highValueStream = db.orders.watch([
  { $match: { 
    operationType: 'insert',
    'fullDocument.total': { $gte: 1000 }
  }}
]);</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Advanced Change Stream Features</h2>
                    <div class="code-container">
                        <div class="code-title">Resumable Change Streams</div>
                        <pre><code class="javascript">// Resume from specific point
const resumeToken = getLastProcessedToken();
const changeStream = db.orders.watch([], {
  resumeAfter: resumeToken,
  fullDocument: 'updateLookup'
});

changeStream.on('change', (change) => {
  // Process change
  processChange(change);
  
  // Store resume token for fault tolerance
  saveResumeToken(change._id);
});

// Start after specific timestamp
const changeStream = db.orders.watch([], {
  startAtOperationTime: Timestamp(1640995200, 1)
});

// Pre and post images (MongoDB 6.0+)
const changeStream = db.orders.watch([], {
  fullDocumentBeforeChange: 'whenAvailable',
  fullDocument: 'updateLookup'
});</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Order Processing Example</h2>
                    <div class="code-container">
                        <div class="code-title">Order Workflow with Change Streams</div>
                        <pre><code class="javascript">// Order processing pipeline
class OrderProcessor {
  constructor() {
    this.setupChangeStreams();
  }
  
  setupChangeStreams() {
    // Watch for new orders
    const newOrderStream = db.orders.watch([
      { $match: { operationType: 'insert' } }
    ]);
    
    newOrderStream.on('change', async (change) => {
      const order = change.fullDocument;
      
      try {
        await this.validateInventory(order);
        await this.processPayment(order);
        
        await db.orders.updateOne(
          { _id: order._id },
          { $set: { status: 'processing', processedAt: new Date() } }
        );
        
        await this.triggerFulfillment(order);
        
      } catch (error) {
        await db.orders.updateOne(
          { _id: order._id },
          { $set: { status: 'failed', error: error.message } }
        );
      }
    });
    
    // Watch for status updates
    const statusStream = db.orders.watch([
      { $match: { 
        operationType: 'update',
        'updateDescription.updatedFields.status': { $exists: true }
      }}
    ]);
    
    statusStream.on('change', (change) => {
      const orderId = change.documentKey._id;
      const newStatus = change.updateDescription.updatedFields.status;
      
      this.sendStatusNotification(orderId, newStatus);
      this.updateOrderAnalytics(orderId, newStatus);
    });
  }
}</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Change Stream Best Practices</h2>
                    <div class="fragment">
                        <h3>Performance Considerations</h3>
                        <ul class="small-text">
                            <li><strong>Oplog Size:</strong> Ensure adequate oplog retention</li>
                            <li><strong>Network:</strong> Changes streamed over network</li>
                            <li><strong>Processing:</strong> Handle changes efficiently</li>
                            <li><strong>Filtering:</strong> Use server-side filtering</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <h3>Best Practices</h3>
                        <ul class="smaller-text">
                            <li>Store resume tokens for fault tolerance</li>
                            <li>Use appropriate batch sizes</li>
                            <li>Filter changes server-side when possible</li>
                            <li>Handle errors gracefully with retries</li>
                            <li>Monitor oplog window and size</li>
                        </ul>
                    </div>
                </section>
            </section>

            <!-- Part 5: Production Deployment -->
            <section>
                <section>
                    <h1>Part 5: Production Deployment</h1>
                    <p class="large-text">MongoDB in Production Environments</p>
                </section>

                <section>
                    <h2>Production Architecture</h2>
                    <div class="architecture-diagram">
                        <h3>Recommended Production Setup</h3>
                        <div style="text-align: center; font-size: 0.7em;">
                            <div style="margin-bottom: 10px;">
                                <strong>Load Balancer</strong>
                            </div>
                            <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
                                <div style="border: 2px solid #ff9900; padding: 6px; border-radius: 3px;">mongos</div>
                                <div style="border: 2px solid #ff9900; padding: 6px; border-radius: 3px;">mongos</div>
                                <div style="border: 2px solid #ff9900; padding: 6px; border-radius: 3px;">mongos</div>
                            </div>
                            <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
                                <div style="border: 2px solid #00ff00; padding: 6px; border-radius: 3px;">
                                    <strong>Shard 1</strong><br>P-S-S
                                </div>
                                <div style="border: 2px solid #00ff00; padding: 6px; border-radius: 3px;">
                                    <strong>Shard 2</strong><br>P-S-S
                                </div>
                                <div style="border: 2px solid #00ff00; padding: 6px; border-radius: 3px;">
                                    <strong>Shard 3</strong><br>P-S-S
                                </div>
                            </div>
                            <div>
                                <div style="border: 2px solid #9900ff; padding: 6px; display: inline-block; border-radius: 3px;">
                                    <strong>Config Servers</strong><br>3-node Replica Set
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Hardware Considerations</h2>
                    <div class="two-column smaller-text">
                        <div class="column">
                            <h3>CPU & Memory</h3>
                            <ul>
                                <li><strong>RAM:</strong> More is better, 64GB+ recommended</li>
                                <li><strong>CPU:</strong> Modern multi-core (8+ cores)</li>
                                <li><strong>Working Set:</strong> Should fit in RAM</li>
                                <li><strong>NUMA:</strong> Disable for consistent performance</li>
                            </ul>
                        </div>
                        <div class="column">
                            <h3>Storage</h3>
                            <ul>
                                <li><strong>SSDs:</strong> Preferred for performance</li>
                                <li><strong>RAID:</strong> RAID 10 for performance + redundancy</li>
                                <li><strong>Separate volumes:</strong> Data, logs, journal</li>
                                <li><strong>XFS filesystem:</strong> Recommended on Linux</li>
                            </ul>
                        </div>
                    </div>
                    <div class="fragment">
                        <h3>Network</h3>
                        <ul class="smaller-text">
                            <li>Low latency between replica set members (&lt;15ms)</li>
                            <li>High bandwidth for initial sync and balancing</li>
                            <li>Dedicated network for inter-cluster communication</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Security Configuration</h2>
                    <div class="code-container">
                        <div class="code-title">Production Security Setup</div>
                        <pre><code class="bash"># Enable authentication and TLS
mongod --auth \
       --tlsMode requireTLS \
       --tlsCertificateKeyFile /etc/ssl/mongodb.pem \
       --tlsCAFile /etc/ssl/ca.pem \
       --bind_ip_all \
       --port 27017

# Create admin user
mongosh --tls --tlsCertificateKeyFile client.pem
use admin
db.createUser({
  user: "admin",
  pwd: passwordPrompt(),
  roles: ["root"]
})

# Create application users
use myapp
db.createUser({
  user: "appUser",
  pwd: passwordPrompt(),
  roles: [
    { role: "readWrite", db: "myapp" },
    { role: "read", db: "analytics" }
  ]
})</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Monitoring & Alerting</h2>
                    <div class="fragment">
                        <h3>Key Metrics to Monitor</h3>
                        <div class="two-column smaller-text">
                            <div class="column">
                                <h4>Performance</h4>
                                <ul>
                                    <li>Operations per second</li>
                                    <li>Query execution time</li>
                                    <li>Index hit ratio</li>
                                    <li>Connection count</li>
                                </ul>
                            </div>
                            <div class="column">
                                <h4>Resources</h4>
                                <ul>
                                    <li>Memory usage</li>
                                    <li>Disk space and I/O</li>
                                    <li>CPU utilization</li>
                                    <li>Network throughput</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="fragment">
                        <h3>Monitoring Tools</h3>
                        <ul class="smaller-text">
                            <li><strong>MongoDB Compass:</strong> GUI monitoring and management</li>
                            <li><strong>MongoDB Atlas:</strong> Cloud monitoring and alerting</li>
                            <li><strong>Ops Manager:</strong> On-premises monitoring solution</li>
                            <li><strong>Third-party:</strong> Datadog, New Relic, Prometheus</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Backup & Recovery</h2>
                    <div class="code-container">
                        <div class="code-title">Backup Strategies</div>
                        <pre><code class="bash"># mongodump - Logical backup
mongodump --host mongodb://user:pass@host:27017/mydb \
          --gzip \
          --out /backup/$(date +%Y%m%d)

# File system snapshots (preferred for large databases)
# 1. Lock database briefly
mongosh --eval "db.fsyncLock()"

# 2. Create filesystem snapshot
lvm snapshot /dev/vg0/mongodb-data

# 3. Unlock database
mongosh --eval "db.fsyncUnlock()"

# Point-in-time recovery with oplog
mongodump --oplog --host rs0/host1,host2,host3

# Restore from backup
mongorestore --host mongodb://host:27017 \
             --gzip \
             /backup/20241215</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Docker Production Setup</h2>
                    <div class="code-container">
                        <div class="code-title">Production Docker Configuration</div>
                        <pre><code class="yaml"># docker-compose.prod.yml
version: '3.8'
services:
  mongodb:
    image: mongo:7.0
    container_name: mongodb-prod
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/mongo_root_password
    secrets:
      - mongo_root_password
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./mongod.conf:/etc/mongod.conf:ro
      - /etc/ssl/mongodb:/etc/ssl/mongodb:ro
    command: mongod --config /etc/mongod.conf
    ports:
      - "27017:27017"
    deploy:
      resources:
        limits:
          memory: 8G
          cpus: '4'

volumes:
  mongodb_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/mongodb
      
secrets:
  mongo_root_password:
    file: ./secrets/mongo_root_password.txt</code></pre>
                    </div>
                </section>

                <section>
                    <h2>Production Checklist</h2>
                    <div class="two-column smaller-text">
                        <div class="column">
                            <h3>Before Go-Live</h3>
                            <ul>
                                <li>‚úì Authentication enabled</li>
                                <li>‚úì TLS/SSL configured</li>
                                <li>‚úì Firewall rules in place</li>
                                <li>‚úì Backup strategy tested</li>
                                <li>‚úì Monitoring set up</li>
                                <li>‚úì Alerting configured</li>
                                <li>‚úì Capacity planning done</li>
                            </ul>
                        </div>
                        <div class="column">
                            <h3>Ongoing Operations</h3>
                            <ul>
                                <li>‚úì Regular backup verification</li>
                                <li>‚úì Security updates applied</li>
                                <li>‚úì Performance monitoring</li>
                                <li>‚úì Capacity tracking</li>
                                <li>‚úì Index optimization</li>
                                <li>‚úì Disaster recovery testing</li>
                                <li>‚úì Documentation updated</li>
                            </ul>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Conclusion -->
            <section>
                <section>
                    <h1>Day 3 Summary</h1>
                    <p class="large-text">Advanced MongoDB Features Mastered</p>
                </section>

                <section>
                    <h2>What We've Accomplished</h2>
                    <div class="fragment">
                        <h3>üîÑ Transactions</h3>
                        <ul class="small-text">
                            <li>ACID properties implementation</li>
                            <li>Multi-document transaction patterns</li>
                            <li>Error handling and retry logic</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <h3>üîß High Availability</h3>
                        <ul class="small-text">
                            <li>Replica set configuration and management</li>
                            <li>Automatic failover mechanisms</li>
                            <li>Read preferences and write concerns</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Key Achievements (Continued)</h2>
                    <div class="fragment">
                        <h3>‚ö° Horizontal Scaling</h3>
                        <ul class="small-text">
                            <li>Sharding architecture and setup</li>
                            <li>Shard key selection strategies</li>
                            <li>Cluster management and monitoring</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <h3>üì° Real-time Applications</h3>
                        <ul class="small-text">
                            <li>Change streams implementation</li>
                            <li>Event-driven architecture patterns</li>
                            <li>Fault-tolerant stream processing</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <h3>üöÄ Production Readiness</h3>
                        <ul class="small-text">
                            <li>Security configuration</li>
                            <li>Monitoring and alerting</li>
                            <li>Backup and recovery strategies</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Production Best Practices</h2>
                    <div class="architecture-diagram">
                        <h3>MongoDB Production Stack</h3>
                        <div style="font-size: 0.8em;">
                            <div><strong>Application Layer</strong></div>
                            <div>‚Üì</div>
                            <div><strong>Connection Pooling & Load Balancing</strong></div>
                            <div>‚Üì</div>
                            <div><strong>MongoDB Cluster (Replica Sets + Sharding)</strong></div>
                            <div>‚Üì</div>
                            <div><strong>Monitoring & Alerting</strong></div>
                            <div>‚Üì</div>
                            <div><strong>Backup & Recovery</strong></div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2>Next Steps & Recommendations</h2>
                    <div class="fragment">
                        <h3>Immediate Actions</h3>
                        <ul class="small-text">
                            <li>Practice with the provided Docker environments</li>
                            <li>Implement transactions in your applications</li>
                            <li>Set up replica sets for your projects</li>
                            <li>Experiment with change streams</li>
                        </ul>
                    </div>
                    <div class="fragment">
                        <h3>Long-term Learning</h3>
                        <ul class="small-text">
                            <li>MongoDB Certification Program</li>
                            <li>Advanced administration courses</li>
                            <li>Cloud deployment with Atlas</li>
                            <li>Performance tuning specialization</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <h2>Resources & Support</h2>
                    <div class="two-column smaller-text">
                        <div class="column">
                            <h3>Documentation</h3>
                            <ul>
                                <li><a href="https://docs.mongodb.com">Official MongoDB Docs</a></li>
                                <li><a href="https://university.mongodb.com">MongoDB University</a></li>
                                <li><a href="https://github.com/mongodb">MongoDB GitHub</a></li>
                            </ul>
                        </div>
                        <div class="column">
                            <h3>Community</h3>
                            <ul>
                                <li><a href="https://community.mongodb.com">MongoDB Community</a></li>
                                <li><a href="https://stackoverflow.com/questions/tagged/mongodb">Stack Overflow</a></li>
                                <li><a href="https://www.mongodb.com/events">MongoDB Events</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="fragment">
                        <h3>Certification Path</h3>
                        <p class="small-text">
                            <strong>MongoDB Certified Developer</strong> ‚Üí <strong>MongoDB Certified DBA</strong>
                        </p>
                    </div>
                </section>

                <section>
                    <h2>Thank You!</h2>
                    <div class="large-text">
                        <p>üéâ <strong>Congratulations!</strong></p>
                        <p>You've mastered advanced MongoDB features</p>
                    </div>
                    <div class="fragment">
                        <h3>Questions & Discussion</h3>
                        <p>Let's discuss your specific use cases and challenges</p>
                    </div>
                </section>
            </section>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/plugin/highlight/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/plugin/notes/notes.min.js"></script>
    <script>
        Reveal.initialize({
            hash: true,
            transition: 'slide',
            transitionSpeed: 'default',
            backgroundTransition: 'fade',
            controls: true,
            progress: true,
            center: true,
            touch: true,
            loop: false,
            rtl: false,
            navigationMode: 'default',
            shuffle: false,
            fragments: true,
            fragmentInURL: false,
            embedded: false,
            help: true,
            pause: true,
            showNotes: false,
            autoPlayMedia: null,
            preloadIframes: null,
            autoAnimateEasing: 'ease',
            autoAnimateUnmatched: true,
            autoAnimateStyles: [
                'opacity',
                'color',
                'background-color',
                'padding',
                'font-size',
                'line-height',
                'letter-spacing',
                'border-width',
                'border-color',
                'border-radius',
                'outline',
                'outline-offset'
            ],
            autoSlide: 0,
            autoSlideStoppable: true,
            autoSlideMethod: null,
            defaultTiming: null,
            mouseWheel: false,
            previewLinks: false,
            postMessage: true,
            postMessageEvents: false,
            focusBodyOnPageVisibilityChange: true,
            keyboard: true,
            overview: true,
            disableLayout: false,
            plugins: [RevealHighlight, RevealNotes]
        });
    </script>
</body>
</html>